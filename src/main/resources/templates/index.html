<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head(title='Dashboard')"></head>
<style>
  .monospace {
    font-family: monospace;
  }

  .ui.cards > .card {
    margin: 0.5em;
    width: calc(33.33% - 1em);
  }

  @media only screen and (max-width: 767px) {
    .ui.cards > .card {
      width: calc(100% - 1em);
    }
  }

  .ui.very.basic.table td {
    padding: 0.3em 0;
  }
</style>
<body class="dashboard-page">
<div th:replace="fragments/header :: header"></div>

<div class="ui container u-margin-vertical-large u-padding-horizontal-medium">

  <!-- ===================== Docker Containers Monitor Section ===================== -->
  <div class="ui segment">
    <h3 class="ui header">
      <i class="docker icon"></i>
      Docker Containers
    </h3>

    <div>
      <span id="dockerStatus">WebSocket ì—°ê²° ì¤‘...</span>
    </div>

    <!-- ì»¨í…Œì´ë„ˆ ì¹´ë“œë¥¼ ë Œë”ë§í•  ìœ„ì¹˜ -->
    <div class="ui cards" id="dockerStatsContainer" style="margin-top: 1em;"></div>
  </div>
  <!-- ===================== End Docker Containers Monitor ===================== -->

</div>

<div th:replace="fragments/footer :: footer"></div>

<!-- WebSocket + STOMP JS ì½”ë“œ -->
<script th:inline="javascript">
  const socket = new SockJS('/ws-docker-monitor');
  const stompClient = Stomp.over(socket);
  stompClient.debug = function(str) {
    console.log(str);
  };

  stompClient.connect({}, function () {
    console.log("WebSocket ì—°ê²° ì„±ê³µ!");
    document.getElementById('dockerStatus').textContent = "ğŸŸ¢ WebSocket ì—°ê²°ë¨";
    document.getElementById('dockerStatus').className = "ui green label";

    stompClient.subscribe('/topic/stats', function (message) {
      console.log("ë©”ì‹œì§€ ìˆ˜ì‹ :", message);
      console.log("ë©”ì‹œì§€ ë‚´ìš©:", message.body);

      try {
        const dockerResponse = JSON.parse(message.body);
        console.log("íŒŒì‹±ëœ ë°ì´í„°:", dockerResponse);

        if (!dockerResponse.dockerPsContainerDtos) {
          console.warn("dockerPsContainerDtosê°€ ì—†ìŠµë‹ˆë‹¤");
          return;
        }

        if (dockerResponse.dockerPsContainerDtos.length === 0) {
          console.log("ì»¨í…Œì´ë„ˆ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤");
          const containerDiv = document.getElementById('dockerStatsContainer');
          containerDiv.innerHTML = '<div class="ui warning message">ì»¨í…Œì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        console.log(`${dockerResponse.dockerPsContainerDtos.length}ê°œì˜ ì»¨í…Œì´ë„ˆ ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤`);
        updateDockerContainers(dockerResponse);
      } catch (error) {
        console.error("ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì—ëŸ¬ ë°œìƒ:", error);
        console.error("ì›ë³¸ ë©”ì‹œì§€:", message.body);
      }
    });
  }, function (error) {
    console.error("WebSocket ì—°ê²° ì‹¤íŒ¨:", error);
    document.getElementById('dockerStatus').textContent = "ğŸ”´ WebSocket ì—°ê²° ì‹¤íŒ¨: " + error;
    document.getElementById('dockerStatus').className = "ui red label";
  });

  function getStatusEmoji(status) {
    if (status.toLowerCase().includes('up')) {
      return 'ğŸŸ¢';
    }
    if (status.toLowerCase().includes('exited')) {
      return 'ğŸ”´';
    }
    if (status.toLowerCase().includes('created')) {
      return 'ğŸŸ¡';
    }
    if (status.toLowerCase().includes('restarting')) {
      return 'ğŸ”„';
    }
    return 'â”';
  }

  function getStatusColor(status) {
    // statusê°€ undefinedì¼ ê²½ìš° ê¸°ë³¸ê°’ ì²˜ë¦¬
    if (!status) {
      console.warn("ìƒíƒœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤:", status);
      return 'grey';
    }

    const statusLower = status.toLowerCase();
    if (statusLower.includes('up')) {
      return 'green';
    }
    if (statusLower.includes('exited')) {
      return 'red';
    }
    if (statusLower.includes('created')) {
      return 'yellow';
    }
    if (statusLower.includes('restarting')) {
      return 'orange';
    }
    return 'grey';
  }

  function formatPorts(ports) {
    if (!ports || ports === '') {
      return 'ì—†ìŒ';
    }
    return ports.split(',').join('<br>');
  }

  function updateDockerContainers(dockerResponse) {
    try {
      const containerList = dockerResponse.dockerPsContainerDtos || [];
      console.log("ì²˜ë¦¬í•  ì»¨í…Œì´ë„ˆ ê°œìˆ˜:", containerList.length);

      const containerDiv = document.getElementById('dockerStatsContainer');
      if (!containerDiv) {
        console.error("ì»¨í…Œì´ë„ˆ divë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
        return;
      }

      containerDiv.innerHTML = '';

      containerList.forEach(container => {
        console.log("ì»¨í…Œì´ë„ˆ ì²˜ë¦¬:", container);

        // null check ì¶”ê°€
        const status = container.Status || container.State || 'Unknown';
        const statusColor = getStatusColor(status);
        const statusEmoji = getStatusEmoji(status);
        const containerName = container.Names ? container.Names.replace(/^\//, '') : 'Unknown';

        const cardHTML = `
        <div class="ui ${statusColor} card">
          <div class="content">
            <div class="header">
              ${statusEmoji} ${containerName}
            </div>
            <div class="meta">
              <span class="ui ${statusColor} label">
                ${status}
              </span>
            </div>
            <div class="description">
              <table class="ui very basic compact table">
                <tbody>
                  <tr>
                    <td><i class="id card outline icon"></i> ID</td>
                    <td class="monospace">${container.ID ? container.ID.substring(0, 12) : 'N/A'}</td>
                  </tr>
                  <tr>
                    <td><i class="docker icon"></i> Image</td>
                    <td>${container.Image || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td><i class="clock outline icon"></i> Created</td>
                    <td>${container.CreatedAt || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td><i class="plug icon"></i> Ports</td>
                    <td>${formatPorts(container.Ports)}</td>
                  </tr>
                  <tr>
                    <td><i class="hdd outline icon"></i> Size</td>
                    <td>${container.Size || 'ì •ë³´ ì—†ìŒ'}</td>
                  </tr>
                  <tr>
                    <td><i class="clock outline icon"></i> Uptime</td>
                    <td>${container.RunningFor || 'N/A'}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="extra content">
            <div class="ui two buttons">
              <button class="ui basic green button" onclick="controlContainer('start', '${container.ID}')"
                      ${status.toLowerCase().includes('up') ? 'disabled' : ''}>
                <i class="play icon"></i> Start
              </button>
              <button class="ui basic red button" onclick="controlContainer('stop', '${container.ID}')"
                      ${!status.toLowerCase().includes('up') ? 'disabled' : ''}>
                <i class="stop icon"></i> Stop
              </button>
            </div>
          </div>
        </div>
      `;

        containerDiv.insertAdjacentHTML('beforeend', cardHTML);
      });
    } catch (error) {
      console.error("ì»¨í…Œì´ë„ˆ ì—…ë°ì´íŠ¸ ì¤‘ ì—ëŸ¬ ë°œìƒ:", error);
    }
  }

  // ì»¨í…Œì´ë„ˆ ì œì–´ í•¨ìˆ˜ (ì¶”í›„ êµ¬í˜„ ì˜ˆì •)
  function controlContainer(action, containerId) {
    console.log(`Container ${action} requested for ID: ${containerId}`);
    // TODO: WebSocketì„ í†µí•´ ì„œë²„ì— ì»¨í…Œì´ë„ˆ ì œì–´ ìš”ì²­ ì „ì†¡
  }
</script>

</body>
</html>
